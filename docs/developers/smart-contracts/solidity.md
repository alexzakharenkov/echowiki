# Solidity

Solidity - язык программирования смарт-контрактов для платформы Ethereum, сам язык похож на JavaScript. Полную документацию по нему можно найти [тут](https://solidity.readthedocs.io).

## Intro

### Важные типы ID

- `1.2.ID` - аккаунт
- `1.16.ID` - контракт
- `1.17.ID` - результат выполнения контракта

### Перевод адресов ECHO <-> Ethereum

Адреса контрактов и аккаунтов имеют длину 20 байт, первые из которых опреледяют,
указывает адрес на контракт или на аккаунт.
Если адрес указывает на аккаунт, то он начинается с `00`,
если на контракт - то с `01`. Таким образом, для перевода из id в echo в адрес ethereum необходимо:

- Исходя из типа записать начало, `00` если переводится ID аккаунта (`1.2.ID`)
  и `01` если ID контракта (`1.16.ID`)
- Взять последние цифры триплета конракта ил
  аккаунта (`1.2.цифры` для аккаунта и `1.16.цифры` для контракта), сначала добавить нулей так,
  чтобы в итоге адрес получился длиной в 20 байт, а затем добавить последние цифры ID
  в 16ричной системе счисления. Например, для аккаунта c ID `1.2.52`
  адрес в ethereum будет `00000000000000000036`.

### Дополнительные возможности Ethereum при использовании с ECHO

Добавлены следующие опкоды:

- `IDASSET` - позволяет получить `ID` ассета по его имени.
- `PROPERTY` + `CONVERT` - позволяет получать настройки сети от ECHO-сервера
- `ASSETBALANCE` - позволяет узнать баланс данного ассета.
- `CALLASSET` - позволяет переводить деньги в указанном ассете.

### Флаг поддерживаемого ассета, флаг приведения точности

TODO

## Creating a smart contract

### With the ethereum toolchain

Контракт можно скомпилировать с помощью [Remix](https://remix.ethereum.org/) прямо в браузере, однако
в таком случае не будут доступны опкоды, добавляемые Echo.

### With solc cutmozied for ECHO

С помощью компилятора [solc](https://gitlab.pixelplex.by/631_echo/solidity) можно скомпилировать
контракт с кастомными опкодами.
[Инструкции](https://solidity.readthedocs.io/en/latest/installing-solidity.html#building-from-source)
по сборке и использованию аналогичны обычному solc.

## Uploading a smart contract

### Running the contract operation

Для загрузки контракта используется [эта](../connect/operations/contract_operations/_contract_operation.md) операция.

### An example with echo_wallet

Чтобы загрузить контракт с помощью `echo_walllet` необходимо:

1. Скомпилировать контракт и скопировать скомпилированный результат. Как пример будет использоваться этот простой контракт:

   ```
    contract Greeter {
        /* Function to recover the funds on the contract */
        function kill() public { selfdestruct(msg.sender); }

        /* Define variable greeting of the type string */
        string greeting = "greet";

        /* Main function */
        function greet() public constant returns (string) {
            return greeting;
        }
    }
   ```

   скомпилировав это контракт получается следующий байткод: ``

2. Запустить echo_wallet, указав ему адрес сервера к которому подключаться, создать пароль, разблокировать кошелёк, импортировать нужные ключи и балансы.
3. Загрузить контракт с помощью create_contract. Функция принимает следующие аргументы:
- Владелец контракта
- Ассет в котором контракту передаются средства
- Код контракта
- Средства, передаваемые контракту
- Цена gas
- Gas, передаваемый контракту
- Нужно ли распространять транзакцию по сети (по умолчанию `false`)
- Нужно ли сохранять транзакцию в кошельке (по умолчанию `true`)

  Пример создания контракта с кодом приведённым выше:
   ```
   create_contract nathan ECHO "60806040526004361061004b5763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166341c0e1b58114610050578063cfae321714610067575b600080fd5b34801561005c57600080fd5b506100656100f1565b005b34801561007357600080fd5b5061007c6100f4565b6040805160208082528351818301528351919283929083019185019080838360005b838110156100b657818101518382015260200161009e565b50505050905090810190601f1680156100e35780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b33ff5b60008054604080516020601f60026000196101006001881615020190951694909404938401819004810282018101909252828152606093909290918301828280156101805780601f1061015557610100808354040283529160200191610180565b820191906000526020600020905b81548152906001019060200180831161016357829003601f168201915b50505050509050905600a165627a7a72305820c6174faf15a04769225a0858f92d663e3be78a44e501eb3607fba6b4b514c6500029" 0 1 2000000 true true
   ```

   Можно подветрдить, что контракт создался с помощью `get_all_contracts`

## Application Programming Interface (API)

### Call smart contracts

Вызов функций контракта происходит через `call_contract`, который получает следующие аргументы:

- Имя аккаунта владельца
- ID контракта
- HEX-код функции для вызова
- Средства, передаваемые при вызове
- Цена на gas
- Gas, передаваемый при вызове
- Нужно ли распространять транзакцию по сети (по умолчанию `false`)
- Нужно ли сохранять транзакцию в кошельке (по умолчанию `true`)

Пример вызова контракта созданного ранее:

```
call_contract nathan 1.16.0 "cfae3217" 0 1 2000000 true true
```

### Get result of deployment or call

### Get properties from Smart Contract

### Internal transactions

### Subscribe to Smart Contract Events

## Fees
// TODO

## Hello world!
