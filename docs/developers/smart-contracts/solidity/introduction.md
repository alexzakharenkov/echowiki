# Echo Ethereum VM

## Introduction

В Echo была интегрирована виртуальная машина Ethereum (EVM), что позволяет загружать и выполнять умные контракты, написанные на Solidity, в сети Echo.

Solidity - это объектно-ориентированный язык высокого уровня для реализации "умных контрактов". Полную документацию по нему можно найти [тут](https://solidity.readthedocs.io).

## Идентификаторы объектов

Для идентификации аккаунтов и контрактов, в отличии от Ethereum, где используются адреса в виде хешей, в Echo используются инкрементые идентификаторы в виде триплетов.

### Некоторые типы идентификаторов в сети Echo:

- `1.2.x` - аккаунт
- `1.16.x` - контракт
- `1.17.x` - результат выполнения контракта

### Конвертация идентификаторов Echo в адреса Ethereum

Для того что бы использовать адрес аккаунта или контракта его нужно конвертировать в адрес Ethereum.

Адрес Ethereum представляет собой 20 байт, из которых:
- Первый байт адреса занимает "короткий" тип. Для аккаунта и контракта он заменяется на 00 и 01 соответственно.
- Следующие 11 байт занимают нули.
- Последние 8 байт занимает `uint64_t` число.

Краткая памятка:
```
ff0000000000000000000000ffffffffffffffff  | Conversion of decimal Echo type
[][ 11 bytes of zeros  ][   8 bytes    ]  |       to hex short type:
^ 1 byte id short type    id instance     |   2 -> 00 - account
                                          |  16 -> 01 - contract
1.2.26 = account 26 (0x1a) =              |  dd -> xx - everything else
000000000000000000000000000000000000001a  |
                                          |
1.16.5 = contract 5 =                     |
0100000000000000000000000000000000000005  |

```

## Совместимость контрактов из Ethereum сети

В контексте смарт-контрактов, сеть Echo имеет 2 серьезных отличия от сети Ethereum, что не позволило бы использовать контракты без их адаптации. Во-первых в отличии от сети Ethereum, сеть Echo имеет не одну валюту, а список ассетов, а во-вторых точность каждого из ассетов отлична от точности Eth (18), так как может настраиваться индивидуально для каждого из ассетов.

Для сохранения совместимости контрактов между сетями, в сети Echo были добавлены параметры создания контракта, которые конфигурируют работу с контрактом.

### Flag of supported asset
Поскольку Echo является мультиассетной системой, а Ethereum нет, то это порождает множество проблем, в основе которых лежат такие различия между ассетами как курс, точность, баланс и т.д. Для решения этих проблем был введён параметр `supported_asset_id`, ограничивающий ассеты, с которыми может работать контракт, до одного указанного в параметре.

Данный параметр является опциональным, его можно указать при создании контракта, передав название ассета в качестве параметра `supported_asset_id`.

- Если параметр не установлен, контракт может быть вызван с любым ассетом.
- Если параметр установлен, то вызовы функций контракта могут быть осуществлены исключительно с данным ассетом.

### Flag of using Ethereum accuracy
В Echo в контракты был добавлен флаг отображающий необходимость приведения к Ethereum точности при работе с балансами в контрактах.

- Если флаг не установлен, при работе с балансами используется оригинальная точность ассета контракта.
- Если флаг установлен, при работе с балансами используется Ethereum точность равная 18 знакам после запятой.

По умолчанию данный флаг выставлен в `false`. Флаг можно выставить при создании контракта передав `true` или `false` в качестве параметра `eth_accuracy`.

К примеру, допустим ассет `ECHO` у нас имеет 5 знаков после запятой и если флаг будет установлен в `false` то при отправке 1 ECHO в контракт придёт сумма `100000`, если же флаг будет установлен в `true` при отправке того же 1 ECHO придёт сумма `1000000000000000000`. Флаг был добавлен для возможности полноценной работы контрактов написанных для `Ethereum`.