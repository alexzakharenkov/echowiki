# Bitcoin Sidechain (Echo)

## Общее описание

Bitcoin Sidechain (BS) - расширение Echo, реализующее шлюз между 
блокчейнами Echo и Bitcoin, позволяет использовать валюту Bitcoin в 
рамках блокчейна Echo и выводить ее из сети Echo обратно в сеть Bitcoin.

Функционал реализуется путем заморозки активов на стороне Bitcoin на 
соответствующем адресе, активацией соответствующего объема средств на 
стороне Echo (для ввода активов в Echo) и обратного процесса для вывода 
средств обратно в Bitcoin-сеть.

Участники комитета сети Echo являются посредниками, реализующими связь 
двух блокчейнов.

## Шаги пользователя

Для любого действия с вводом или выводом средств, предварительно 
пользователь должен создать аккаунт и запросить адрес пополнения:

1.	зарегистрировать новый аккаунт в любом кошельке Echo;
2.	отправить в сеть операцию - запрос создания нового адреса пополнения.

### Ввод Bitcoin

1.	в сети 	Bitcoin должен перевести BTC на сгенерированный выше адрес;
2.	дождаться подтверждения перевода в сети Echo и получить возможность 
использовать соответствующий баланс в eBTC в сети Echo.

### Вывод Bitcoin

1.	отправить eBTC на Bitcoin адрес в сети Echo;
2.	дождаться подтверждения перевода и получить возможность использовать 
соответствующий баланс на указанном выше адресе в сети Bitcoin. 

## Протокол работы Sidechain

### Основные разделы протокола

1.	Создание Bitcoin адреса пополнения.  	
2.	Обработка ввода Bitcoin.  	
3.	Обработка вывода Bitcoin. 

### Создание Bitcoin-адреса

1.	Отправка операции на создание адреса.  	
2.	Генерация адреса. 

Адрес представляет из себя segwit multisig (кастомный скрипт). Скрипт 
данного адреса позволяет вернуть средства отправителю в случае неполадок 
шлюза.

Пользователь генерирует транзакцию содержащую операцию create bitcoin 
address и отправляет эту транзакцию в сеть echo. При обработке данной 
транзакции будет создан bitcoin address, привязанный к учетной записи 
пользователя.

### Обработка ввода Bitcoin

**1\. мониторинг транзакций на адреса пополнения**

Все члены комитета слушают блокчейн bitcoin. Каждый из участников 
комитета проверяет каждый блок на наличие транзакций на адреса
пополнения 

**2\. Информирование сети о транзакции**

После получения блока bitcoin, в котором находится транзакция, 
содержащая адрес, созданный в echo, члены комитета отправляют операцию 
с информацией о данном вводе BTC в блокчейн echo. Отправленная операция 
создает новый объект, хранящий информацию о вводе BTC, если такового 
объекта еще нет. Или наращивает счётчик, если такой объект уже 
существует. После того, как счётчик объекта больше двух третей от 
количества активных членов комитета, мы можем его рассматривать как 
действительный. При обработке блока echo протокол, при наличии 
действительных вводов/выводов, создает объект, хранящий 
биткоин-транзакцию для перевода BTC с адреса, созданного для 
пользователя на адрес хранилища средств. 

**3\. Перевод средств на адрес хранилища**

После того, как транзакция будет сформирована, членам комитета 
необходимо подписать своими приватными ключами 
bitcoin-транзакцию, находящуюся в объекте. Как только транзакция 
будет подписана 2/3 + 1 активных членов комитета, она будет 
отправлена в сеть bitcoin (всеми членами комитета). 

**4\. Зачисление средств на аккаунт**

После подтверждения отправленной транзакции на стороне bitcoin, 
пользователю Echo перечисляется eBTC.

### Обработка вывода Bitcoin

Пользователь создаёт транзакцию, содержащую операцию вывода BTC, и 
отправляет её в сеть echo. При обработке транзакции создается объект, 
содержащий информацию о выводе. При обработке блока echo протокол, при 
наличии действительных вводов/выводов, создает объект хранящий 
биткоин-транзакцию. После этого, членам комитета необходимо подписать 
своими приватными ключами bitcoin-транзакцию, находящуюся в объекте. 
Как только транзакция будет подписана больше, чем 2/3 активных членов 
комитета, она будет отправлена в сеть bitcoin (всеми членами комитета). 
После подтверждения отправленной транзакции на стороне bitcoin, 
пользователь может воспользоваться BTC на стороне bitcoin.

## Смена хранилища средств

### Описание проблем

По той причине, что все BTC, введенные в echo, хранятся на одном vout 
хранилища средств, и ключи всех активных членов комитета есть в скрипте 
адреса хранилища средств, необходимо при смене активных членов комитета, 
заменить ключи из sidechain управляющего аккаунта и создавать новый 
адрес для хранилища средств, основанный на ключах новых активных членов 
комитета.

Так же необходимо совершить перевод с одного адреса хранилища средств на 
новый, но для этого нужно ограничить количество сменяемых активных членов 
комитета за один maintenance. Это сделано для того, чтобы оставалось 
определенное количество  активных членов комитета, способных подписать 
vin для перевода на новый адрес хранилища средств.

Так же возникает проблема, что BTC не могут быть переведены с одного 
адреса на другой просто так, так как непонятно, кто будет оплачивать 
комиссию за транзакцию в сети Bitcoin.

Следующая смена хранилища средств не может быть произведена, пока не 
подтверждается транзакция с предыдущей сменой.

Это сделано по следующим причинам:

Предположим, что следующая смена хранилища средств прошла, не дождавшись 
подтверждения предыдущей транзакции на смену хранилища средств. Обе 
транзакции попали в чейн Bitcoin. Произошёл форк сети Bitcoin и 
транзакции попали в ветку, которая впоследствии будет удалена. 
Изначальных активных членов комитета, которые были до обеих смен 
хранилища средств, осталось меньше чем необходимое количество, чтобы 
подписать новый перевод на хранилища средств 2. Именно поэтому 
необходимо блокировать смену активных членов комитета (хранилища средств), 
пока не подтвердится предыдущая транзакция на смену.

По нашему сценарию смена адреса хранилиза будет происходить следующим 
образом:

* Определяется список новых активных членов комитета. На момент 
maintenance будет сменено определённое количество активных членов 
комитета. Оставшееся количество должно быть таким, чтобы оно могло 
подписать транзакцию на смену хранилища средств. Если же на момент 
maintenance, при подсчете голосов сложилась ситуация, при которой 
старых активных членов комитета остаётся меньше, чем должно быть для 
возможности подписать перевод, то остаётся столько активных членов 
комитета сколько нужно для подписи, остальные меняются на новые. 
Оставшиеся же активных членов комитета, которые должны были стать 
новыми, но не стали, поменяются на следующем maintenance, после того как 
подтвердится перевод на новый адрес хранилища средств.
* Ключи активных членов комитета, которые были удалены из списка 
активных на этом maintenance удаляются из sidechain управляющего аккаунта.
* Создаётся новый адрес хранилища средств, основанный на ключах новых 
активных членов комитета.
* Далее ожидается ввод или вывод BTC.
* Как только появляется новый ввод или вывод, активные члены комитета, 
ключи которых есть в старом адресе хранилища средств, подписывают 
транзакцию.
* В транзакцию кладётся vout уже на новый адрес хранилища средств.
* Транзакция отправляется в сеть.
