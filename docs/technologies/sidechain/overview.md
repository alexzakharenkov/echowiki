# Ethereum Sidechain

## Общее описание

Ethereum Sidechain (ES) - расширение Echo, реализующее щлюз между блокчейнами Echo и Ethereum.
Данное расширение позволяет использовать валюту Ethereum и его ERC20 токены в рамках блокчейна Echo,
а также выводить их из сети Echo обратно в сеть Ethereum.

Функционал реализуется путем заморозки активов на стороне Ethereum на соответствующем контракте и
активацией соответствующего объема средств на стороне Echo (для ввода активов в Echo) и обратного
процесса для вывода средств обратно в Ethereum сеть.

Участники комитета сети Echo являются посредниками, реализующими связь двух блокчейнов. Основным элементом
шлюза является Solidity контракт в сети Ethereum, который отвечает за генерацию адресов пополнения, обработку
входящих платежей и обработку исходящих платежей.

### Шаги пользователя

Для любого действия с вводом или выводом средств, предварительно пользователь должен создать аккаунт и
запросить адрес пополнения:

1. регистрирует новый аккаунт в любом кошельке **Echo**
1. отправляет в сеть операцию - запрос создания нового адреса пополнения
1. дожидается подтверждения создания адреса

#### Ввод Ethereum

1. в сети Ethereum переводит ETH на сгенерированный выше адрес
1. дожидается подтверждения перевода в сети **Echo** и получает возможность использовать соответствующий баланс
в eETH в сети Echo

#### Ввод ERC20 token

> шлюз поддерживает только те ERC20 токены, адреса которых были заявлены на поддержку. Механизм описан ниже.

1. в сети Ethereum переводит ERC20 токен на сгенерированный выше адрес
1. дожидается подтверждения перевода в сети **Echo** и получает возможность использовать соответствующий баланс
в соответсвтующем ERC20 токене в сети Echo

#### Вывод Ethereum

1. отправляет eETH на Ethereum адрес в сети Echo
1. дожидается подтверждения перевода и получает возможность использовать соответствующий баланс на указанном
выше адресе в сети Ethereum

#### Вывод ERC20 токена

1. вызывает метод `approve` ERC20 токена, указывая сумму, которую необходимо вывести, затем вызывает метод
`withdrow` сервисного контракта, указывая токен, сумму и адрес в сети Ethereum, на который необходимо вывести
токены. Данных шаг подразумевает наличие двух операций, которые могут происходить в фоне приложения, которое
предоставляет возможность пользователю выполнить их, указав только сумму и адрес вывода
1. дожидается подтверждения перевода и получает возможность использовать соответствующий баланс на указанном
выше адресе в соответствующем ERC20 токене в сети Ethereum

### Протокол работы Sidechain

Основные разделы протокола

1. Создание Ethereum адреса пополнения
1. Обработка ввода Ethereum
1. Обработка ввода ERC20 токенов
1. Обработка вывода Ethereum
1. Обработка вывода ERC20 токенов

#### Создание Ethereum адреса

Создание адреса происходит в 4 шага:

1. отправка заявки на создание адреса
1. генерация адреса
1. подтверждение созданного адреса

##### Отправка заявки на создание адреса

Используя операцию `sidechain_create_address`, пользователь извещает сеть о намерении получить Ethereum адрес
пополнения `eth_receive_address`. Операция включает в себя тип сайдчейна (ethereum в данном случае).

> Для предоставления возможностьи использовать Sidechain без наличия баланса в сети Echo, комиссия при создании
операции `sidechain_create_address` равна нулю, но при этом пользователь может только единожды вызвать операцию
для одного аккаунта

##### Генерация адреса

Участники комитета подписанны на тип операций `sidechain_create_address`. При запросе адреса, участник
комитета, выбранный с импользованием VRF, отправляет запрос в сеть Ethereum (вызов контракта Ethereum) для
создания адреса пополнения, привязанного к необходимому аккаунту в сети Echo.

##### Подтверждение созданного адреса

Вызов контракта провоцирует событие (event) на стороне Ethereum с информацией о новом адресе. Данное событие
каждый из участников комитета отлавливает в сети Ethereum и создает соответствующую операцию в сети Echo в
случае его обнаружения.

Адрес `eth_receive_address` будет создан уже после первого сообщения одного из участников комитета и может
быть использовать дня пополнения баланса. Однако пользователям не рекомендуется использовать адрес до тех пор,
пока он не получит подтверждение от `3 / 2 n + 1` участников комитета, где `n` - количество активных учасников
комитета. Данное ограничение является только рекомендацией и никак не ограничивает использование адреса на
уровне протокола.

#### Обработка ввода Ethereum

В результате перевода активов Ethereum на адрес `eth_receive_address`, контракт создает событие (event) в сети
Ethereum. Это событие обрабатывается всеми участниками комитета, каждый из них создает операцию с информацией
о поступлении средств в сети Echo. После того, как `3 / 2 n + 1` участников комитета отправят сообщение о
поступлении, средства будут зачислены на соответствующий аккаунт Echo.

Результатом ввода Ethereum в сеть Echo является наличие баланса eETH на аккаунте в сети Echo.

#### Обработка ввода ERC20 токенов

ERC20 - это стандарт контракта Solidity, который подразумевает методы получения баланса аккаунта и перевода
активов. В сети Echo он представлен аналогичным типом контрактов.

Перевод ERC20 токенов в сеть Echo реазизуется в 2 шага:

1. создание контракта токена в сети Echo
1. пополнение резерва комиссии контракта (fee pool)
1. перевод активов на `eth_receive_address` в сети Ethereum

##### Создание контракта токена в сети Echo

В первую очередь потенциальный владелец контракта токена на стороне Ethereum должен активировать возможность
использовать его токены на стороне Echo. Для этого необходимо вызвать операцию `sidechain_create_token`. В
операции указываются адрес ERC20 контракта в сети Ethereum. Операция имеет ненулевую комиссию.

В результате данной операции участники комитета делают запрос на наличие контракта с указанным адресом в сети
Ethereum, проверяют его на соответствие интерфейсу ERC20 (контракт должен содержать все методы и события,
входящие в ERC20 стандарт). Каждый из участников отправляет фид с информацией о контркте в сеть Echo и при
получении фидов от `3 / 2 n + 1` участников комитета, в сети Echo создается ERC20 mintable токен, выпускать
токены которого имеет право только аккаунт комитета.

Адрес контракта в сети Ethereum привязывается к идентификатору контракта в сети Echo.

Последующие операции `sidechain_create_token` с указанием идентичного адреса контракта участниками комитета не
обрабатываются.

##### Пополнение fee pool

Для возмещения расходов вывода средств ERC20 токенов, контракт токена на стороне Echo должен иметь свой
ненулевой баланс fee pool. Пополнить баланс может любой аккаунт. Вывод ERC20 токенов в сеть Ethereum будет
возможен только в случае достаточного баланса на fee pool для погашения расходов на транзакцию вывода.

##### Перевод активов в сеть Echo

С момента добалвения связки контрактов из пункта выше, участники комитета следят за всеми событиями `Transfer`
контракта в сети Ethereum. При поступлении нового события `Transfer` в котором в качестве получателя выступает
один из `eth_receive_address` сети Echo, все участники комитета фидят информацию о событии в сеть Echo. При
получении фидов от `3 / 2 n + 1` участников комитета от имени аккаунта комитета вызывается связанный ранее
ERC20 контракт с запросом на mint нужного количества токенов на аккаунт, привязанный к `eth_receive_address`.

Результатом ввода ERC20 токена в сеть Echo является наличие баланса соответсвтующего ERC20 токена на аккаунте
в сети Echo.

#### Обработка вывода Ethereum

1. вывод средств пользователем
1. формирование подписей участниками комитета
1. отправка вывода в сеть Ethereum
1. подтверждение вывода

##### Вывод средств пользователем

Перевод eETH с указанием получателя формата `0x0000000000000000000000000000000000000000` будет воспринят сетью
как вывод ETH в сеть Ethereum.

##### Формирование подписей

Каждый участник комитета, получив блок с операцией вывода eETH, формирует подпись, которая включает в себя
идентификатор вывода, сумму, адрес получателя, идентификатор отправителя. Подпись отправляется в сеть Echo
в соответствующей операции `sidechain_propose_signature`.

##### Отправка вывода в сеть Ethereum

При получении нужного количества подписей (`3 / 2 n + 1`) участник комитета, определенный через VRF, вызывает
метод `withdrow` в контракте Echo на стороне Ethereum.

##### Подтверждение вывода

Вызов контракта на стороне Ethereum провоцирует вызов события (event). Данный событие каждый из участников
комитета проксирует в операцию в сети Echo. При получении нужного количества опреаций (`3 / 2 n + 1`) вывод
считается закрытым. Сумма eETH, равная сумме, выведенного ETH, сжигается.

#### Обработка вывода ERC20 токена

1. подготовка вывода
1. заявка на вывод
1. формирование подписей участниками комитета
1. отправка вывода в сеть Ethereum
1. подтверждение вывода

##### Подготовка вывода

Предварительно для вывода токенов пользователь должен позволить системному аккаунту перевести нужную сумму на
свой адрес. Это реализуется путем вызова метода `approve` с указанием в качестве получателя адреса системного
контракта и необходимой для вывода суммы.

##### Заявка на вывод

Пользователь должен вызвать метод `withdrow` системного контракта, указав адрес токена, сумму вывода и адрес,
на который необходимо вывести токен. Контракт, используя метод `transferFrom` переводит средства на свой адрес,
используя метод `burn`, сжигает полученные токены и отправляет в сеть событие (event), информирующее участников
комитета о необходимости вывода токена.

##### Формирование подписей

Каждый участник комитета, получив блок с событием о необходимости вывода токена, формирует подпись, которая
включает в себя идентификатор вывода, сумму, адрес получателя, идентификатор отправителя и адрес токена.
Подпись отправляется в сеть Echo в соответствующей операции `sidechain_propose_signature`.

##### Отправка вывода в сеть Ethereum

При получении нужного количества подписей (`3 / 2 n + 1`) участник комитета, определенный через VRF, вызывает
метод `withdrow` в контракте Echo на стороне Ethereum.

##### Подтверждение вывода

Вызов контракта на стороне Ethereum провоцирует вызов события (event). Данный событие каждый из участников
комитета проксирует в операцию в сети Echo. При получении нужного количества опреаций (`3 / 2 n + 1`) вывод
считается закрытым.

### Дополнительный функицонал

#### Возмещение комиссии

Выполнение транзакций с созданием адреса пополнения и выводом средств требуют затраты ETH на стороне сети
Ethereum. Изначально комиссию оплачивает член комитета, который вызывает данную транзакцию в сети Ethereum.

Возмещение расходов происходит в момент вывода средств пользователем. В случае, если пользователь еще не
погасил задолженность за создание адреса пополнения, при выводе Ethereum на конечный адрес будет переведена
сумма вывода за вычетом стоимости создания адреса пополения и стоимости транзакции вывода. Таким образом,
участники комитета получают затраченный ETH в сети Ethereum.

Учитывая, что не все транзакции создания адреса будут возмещены, частично компенсация расходов будет
происходить за счет получения процента комиссии за операции в сети Echo.

Комиссия за транзакции вывода токенов возмещается на стороне Echo в eETH путем списания ее на баланс участника
комитета с баланса fee pool.

## Исключительные ситуации

### Имя аккаунта формата `0x0000000000000000000000000000000000000000`

Чтобы исключить ситуации пересечения адреса в сети Ethereum и имени аккаунта на стороне Echo, на стороне Echo
запрещено создавать аккаунты с именем, совпадающим с форматом адреса криптовалют, а именно имена, формата

- `0x0000000000000000000000000000000000000000` (Ethereum addresses)
- `0000000000000000000000000000000000` (UTXO addresses)

### Перевод отличного от eETH ассета на адрес Ethereum

Для того, чтобы не допустить ситуации, при которой пользователь переведет на адрес Ethereum ассет отличный от
eETH, на дареса такого типа разрешено переводить только eETH.

### Обработка форков на стороне Ethereum

Так как на стороне Ethereum возможны форки, все события из сети должны передаваться в сеть Echo с отставанием в
`N` блоков, где `N` - параметризуемое значение.

### Недобросовестная работа участника комитета

#### Ложный адрес пополнения

Так как участник комитета может отправить операцию о новом адресе пополнения, указав неправильный адерс, сеть
должна выбирать и сохранять тот адрес, который набирает больше подтверждений. Подтвержденным является адрес,
набравший `3 / 2 n + 1` голосов участников комитета.

#### Выбранный VRF участник не отправляет транзакцию в сеть Ethereum

Протоколом предусмотрен допустимый слот времени, привязанный к количеству блоков, за который участник комитета
должен отправить транзакцию в сеть Ethereum и все остальные должны получить событие о транзакции. В случае,
когда за указанный интервал времени участники комитета не получают событие, определяется следующий участник,
который должен отправить транзакцию в сеть.

Для информацитивности, при пропуске слота участником комитета уличивается инкремент пропущенных слотов.
Информацию может видеть каждый, что может стать поводом голосования за другого участника комитета.

Количество блоков одного слота является параметризируемым значением.

### Возможность использовать eETH без дополнительного ассета

eETH является полноценным ассетом в сети Echo, в котором должна быть возможность оплачивать комисси за
операции. Fee pool ассета не пополняется, а комиссия, оплачиваемая в eETH, распределяется согласно принятому
протоколу, аналогично распределению комиссии в ECHO.

Сумма комиссии зависит от курса обмена eETH на ECHO, которую устанавливают участники комитета, используя
функционал фидов.

### Смена участников комитета на стороне Echo

При смене участников комитета на стороне Echo, появляется необходимость изменить публичные ключи в контракте
на стороне Ethereum. Для этого каждый из текущих участников комитета отправляет в сеть операцию со своей
подписью о смене участников.

После того, как в сеть пришло `3 / 2 n + 1` голосов текущих участников, последний добавленный участник комитета
отправляет транзакцию в сеть Ethereum, вызывая метод контракта `changeCommittee`.

Вызов контракта провоцирует событие (event) на стороне Ethereum с информацией о новом списке участников
комитета. Данное событие каждый из участников комитета отлавливает в сети Ethereum и создает соответствующую
операцию в сети Echo в случае его обнаружения.

Новый участник комитета становится активным только в том случае, если сеть получила `3 / 2 n + 1` сообщений о
событии в сети Ethereum.

## Описание технических элементов

### Операции sidechain

#### Операция запроса адреса пополнения

// TODO

#### Операция о событии создания нового адреса

// TODO

// TODO - дополнить все операции, которые были добавлены

### Объекты sidechain

// TODO - добавить описание всех объектов, которые будут созданы


### Интерфейсы контрактов

#### Ethereum Sidechain Contract Interface

Интерфейс контракта в сети Echo, отвечающий за ввод и вывод средств, создание адреса пополнения.

// TODO

#### Mintable ERC20 Token

Интерфейс контракта токена, загружаемый в сеть Echo в результате запроса активации Sidechain для ERC20 токена.

// TODO

#### ERC20 Token Interface

Минимальный интерфейс ERC20 токена, требуемый сетью Echo

// TODO
