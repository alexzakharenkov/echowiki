# Sidechain

## Definition list

[**DPOS**](http://docs.bitshares.org/bitshares/dpos.html) - Delegated proof-of-stake

[**Witnesses**](http://docs.bitshares.org/bitshares/user/witness.html) - Echo network participants who perform the processing of transactions between Ethereum/Echo networks. Selected by voting

[**Smart contracts**](https://en.wikipedia.org/wiki/Smart_contract) - applications written in Solidity and running in the EVM environment

[**Assets**](http://docs.bitshares.org/bitshares/user/assets.html) - a form of currency in Echo network that can be created and released by users

**eETH** - a presumed asset in Echo network that corresponds to ETH

## What is SideChain

Sidechain is an ETH transaction protocol that is executed between Ethereum and Echo networks. The protocol also describes the process of creating "mirror" assets within Echo. Sidechain is based on smart contract technology and dPOS consensus.

## Requirements

- Ability to convert ETH into an Echo asset
- Ability to convert an Echo asset into ETH

## Witnesses

Witnesses - Echo network participants that fulfill a bridging function between Ethereum/Echo networks. Performing an action within the protocol requires the consent of a qualified majority of the current witnesses. A qualified majority is more than two-thirds of the votes.

The initial set of witnesses is set in the genesis block of Echo network and can be subsequently changed (see [Changing the set of witnesses] (#changing-the-set-of-witnesses)). The main task that witnesses perform is the processing of the events generated by smart contracts.

## Smart contracts

Users send their funds to the smart contract of a corresponding network. This transaction generates an event that gets processed by the witnesses. The presumed smart contract structure is described below.

| Ethereum | Echo |
|--|--|
| `map<id, set<Address>> votes`<br>`array<address> wits`<br>`array<hash> votes` | `map<id, int> votes`<br>`array<account_id> wits` |
|`EthToEcho(to)`<br>`EchoToEth(id, to, val)`<br>`replaceWits(array<address> new)`| `EthToEcho(id, to, val)`<br>`EchoToEth(to)`<br>`replaceWits(array<account_id> new)` |

An Echo smart contract is initialized in a genesis block.

### Ethereum

`map<id, set<Address>> votes` associative array that compares the transaction ID with the received votes.

`set<address> wits` the current set of witnesses

`EthToEcho(to)`
The addressee's ID is sent as a parameter within Echo network and the method generates an event containing:

- unique transaction ID
- addressee from the method parameter
- attached amount of ETH (transfer amount)

This method can be called by any user

`EchoToEth(id, to, val)`
The transaction ID, the addressee's ID and the transfer amount within Echo network are sent as parameters. The method should add the sender's address to the votes[id].
If the amount of the votes[id] equals the nearest integer to 2*|wits|/3 (rounded up), transfer ETH in the amount of val to the address to.

This method can be called by current witnesses only

### Echo

Echo smart contract is symmetric with Ethereum smart contract, except for the need to store a set of witnesses (they can be obtained through the EVM-Echo interface).

There is also a difference in the accrual of funds when transferring. Echo smart contract generates new assets, while Ethereum smart contract sends the funds from its balance.

To act as an equivalent of ETH in Echo network, an asset eETH is created. The entire available asset balance is initially released to the sidechain contract balance in the genesis block.

## How the protocol operates

As mentioned above, witnesses monitor the events of smart contracts, verify transactions, vote for them.

### Transaction Ethereum -> Echo

![Eth -> Echo](./sidechain-images/EthToEcho.png)

The base case looks as follows:

- The user calls EthToEcho method of Ethereum smart contract, using Echo network account address as an argument and attaching the funds that the user wants to transfer
- When processing Ethereum transaction, an event is generated
- The witnesses receive the event, call EthToEcho method of Ethereum smart contract, transfer the parameters of the presumed transaction increasing the vote count
- Upon reaching the required number of votes on Echo smart contract, the specified amount of eETH is sent to the addressee's ID

> At an unsuccessful attempt to release funds on the account due to its absence - Echo smart contract releases the event onEthReturn, which is processed just like the event onEchoRecieved. It turns out that the transfer will be performed according to the scheme of transferring money from Echo network to Ethereum network. The presence of a new event is only necessary to see that it was an automatic return of funds, and not a manual withdrawal from Echo network. As an option, the sender's account can be indicated within the event, in a form of some  system address (the oracle contract address in Echo network; but the option with a separate event is more obvious)

### Transaction Echo -> Ethereum

![Echo -> Eth](./sidechain-images/EchoToEth.png)

- The user calls Ê»EchoToEth` method of Echo smart contract, using Ethereum network account address as an argument and attaching eETH asset that the user wants to withdraw
- When processing the transfer, an event is generated
- The witnesses receive the event, call `EchoToEthSig` method of Echo smart contract, transfer the withdrawal parameters and the signature.
- Upon reaching the required number of signatures on Echo smart contract, the event `transactionReady` is generated, containing all the data and signatures.
- The event is displayed to the user. The user sends the received data to `Ethereum` smart contract. Afterwards, the specified amount is transferred to the address specified in the parameters address (which can't be changed since they are already signed). Basically, a call can be paid by any address, however the money will be sent exactly to the one specified in the parameters.

### Changing the set of witnesses

Changing the set of witnesses happens during the network maintenance. A maximum of `1/3*n-1` can change at a time. This is necessary so that only the witnesses remaining in the current set could confirm the change, without those who were excluded and added.

After the changing of witnesses, on the Echo side the protocol calls the method `replaceWits(array<address> new_wits)` of the contract (the virtual confirmations is not necessary). The method replaces the set of accounts which correspond to the witnesses in the contract. On the Echo side, the current witnesses call the method `replaceWits(sig_t sig)` of the contract, where the signatures of the new set of witnesses are sent to. Upon receiving of the signature, it is compared with the set of witnesses that were sent by the protocol, and the signature is saved. Upon reaching the required number of signatures - these data must be transferred to Ethereum smart contract, using a manual call. **Any account** can do this, but presumably it's done by the witness.

## Witness reward

In order to repay the commission paid for the release of transactions, as well as to stimulate witnesses' work, witnesses are daily getting 20% of all the fees for the transactions within Echo network.
