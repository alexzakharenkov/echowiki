
![20180713_154557](20180713_154557.jpg)

# Используемые определения

**DPOS** - Delegated proof-of-stake

**Заверители (witnesses)** - участники сети ECHO, выбираемые голосованием, осуществляющие обработку переводов между сетями Ethereum/ECHO
(http://docs.bitshares.org/bitshares/dpos.html)
(https://bitshares.org/technology/delegated-proof-of-stake-consensus/)


**Смарт-контракты** (https://ru.wikipedia.org/wiki/Смарт-контракт) - Приложения на языке Solidity, работающие в EVM окружении

**Актив** (http://docs.bitshares.org/bitshares/user/assets.html) - вид валюты на сети ECHO, может создаваться и выпускаться пользователями.

**Lightning Network** (https://en.wikipedia.org/wiki/Lightning_Network) - офчейн протокол второго уровня, построеный над блокчейном с целью осуществления транзакций с наименьшей комиссией.

# Содержание
[[_TOC_]]

# Что такое SideChain
Sidechain это протокол переводов eth между сетями Ethereum и ECHO. Протокол также описывает процесс создания "зеркальных" активов на сети ECHO. В основе лежит технология смарт-контрактов и консенсус DPOS.


## Какие задачи решает SideChain

## Требования

- Возможность конвертации eth в ECHO токен
- Возможность конвертации ECHO токена в eth

# Сценарии использования

## Бизнес сценарии

- Проведение ICO на блокчейне ECHO, принимающий платежи в ECHO и Ethereum
- Приложение с частыми платежами в ETH. К примеру, кофейня
с возможностю покупать кофе за эфир - пользователи пополняют свой баланс
(вводят из чейна ethereum эфир на чейн ECHO), при этом платят комиссию.
Расчитываются за кофе (комиссию не платят). Владелец кофейни только тогда,
когда соберет достаточно средств и решит их вывести, выводит их на кошелек
эфира (платит комиссию).
- Игра на смартконтракте ECHO, в которой пользователи будут вводить и
выводить Ethereum. Пользователь вводит эфир, играет на этот eETH на сети
ECHO, может быть выигрывает что-то и в результате выводит то, что выиграл
на свой адрес Ethereum

## Пользовательские сценарии

### Eth -> ECHO

1. пользователь открывает кошелек echo
2. в списке балансов находит Ethereum
3. жмет “пополнить баланс”
4. в кошельке отображается сообщение вроде “Переведите необходимую сумму
на адрес 0x… указав значение `data` 0x…”
5. пользователь открывает кошелек ethereum, указывает сумму, адрес и data.
Отправляет транзакцию. Баланс после подтверждения появляется на Echo

### ECHO -> Eth

1. пользователь открывает кошелек echo
2. в списке балансов находит Ethereum
3. жмет “вывести баланс”
4. приложение просит пользователя указать адрес, на который необходимо
вывести средства, и сумму, которую необходимо вывести
5. после заполнения полей пользователь отправляет форму тем самым отправляя
транзакцию в сеть

# Заверители

Заверители - участники сети ECHO выполняющие связующую функцию между сетями Ethereum/ECHO. Для совершения действий в рамках протокола нужно согласие квалифицированного большинства текущего состава заверителей. Квалифицированное большинство составляет более двух третьих от общего количества голосов.

Начальное множество заверителей задается в genesis блоке сети ECHO, впоследствии оно может меняться (см. [Изменение набора заверителей](#изменение-набора-заверителей)). Основная задача заверителей - обработка событий, генерируемых смарт-контрактами.

# Смарт-контракты
Пользователи переводят свои средства на смарт-контракт соответствующей сети. Данный перевод генерирует некоторый объект события, который обрабатывается заверителями. Предполагаемая структура контрактов описана ниже.

| Ethereum | ECHO |
|--|--|
| `map<id, int> votes`<br>`array<address> wits`<br>`array<hash> votes` | `map<id, int> votes`<br>`array<account_id> wits` |
|`EthToEcho(to)`<br>`EchoToEth(id, to, val)`<br>`replaceWits(array<address> new)`| `EthToEcho(id, to, val)`<br>`EchoToEth(to)`<br>`replaceWits(array<account_id> new)` |

## Ethereum
`В текущем варианте заверитель может проголосовать несколько раз`

`map<id, int> votes` ассоциативный контейнер, сопоставляющий id перевода c количеством полученных голосов. 0 - значение по умолчанию.

`set<address> wits` множество текущих заверителей

`EthToEcho(to)`
В качестве параметра передается адрес получателя на сети ECHO
метод генери  рует событие, содержащее
- id совершаемого перевода, должен быть уникальным
- получателя из параметра метода
- количество eth прикрепленного к вызову (сумма перевода)

Этот метод может вызывать любой пользователь

`EchoToEth(id, to, val)`
В качестве параметра передается id перевода из сети ECHO, адрес получателя, сумму перевода
Метод должен увеличить значение votes[id] на 1
Если значение votes[id] равно ближайшему целому к 2*|wits|/3 (с округлением в большую сторону) выполнить перевод eth в количестве val на адрес to.

Этот метод могут вызывать только текущие заверители

## Echo
Смарт контракт для ECHO симметричен контракту на Ethereum за исключением необходимости хранения множества заверителей (они могут быть получены через EVM-ECHO интерфейс).

Также присутствует отличие в начислении средств пользователям при переводе. ECHO контракт генерирует новые активы, в то время как Ethereum контракт отправляет средства из своего баланса.

# Дополнительные изменения в протоколе Echo
В качестве аналога eth на сети ECHO создается актив eEth, выпускаемый для аккаунта пользователя при переводе Ethereum -> ECHO и уничтожаемый при переводе ECHO -> Ethereum (в соответствующих количествах)

# Работа протокола
Как упомянуто выше, заверители отслеживают события смарт-контрактов, проверяют транзакции, голосуют за них.

## Транзакция Ethereum -> Echo
Базовый сценарий выглядит так:
- Пользователь вызывает метод EthToEcho смарт-контракта на ethereum, в качестве аргумента передавая адрес акаунта на сети ECHO и прикрепляя средства, которые он хочет перевести
(**что будет если нет такого аккаунта на ECHO?**)
- При обработке транзакции ethereum генерируется событие.
- Заверители получают событие, вызывают метод EthToEcho смарт-контракта на ECHO, передавая туда параметры предполагаемой транзакции и увеличивая счетчик голосов.
- По достижению необходимого количества голосов на смарт-контракте ECHO осуществляется выпуск указанного количества eEth на адрес получателя.

## Транзакция Echo -> Ethereum

- Пользователь вызывает метод EchoToEth смарт-контракта на ECHO, в качестве аргумента передавая адрес аккаунта на сети Ethereum и прикрепляя актив eEth, который он хочет вывести
- При обработке перевода генерируется событие.
- Заверители получают событие, вызывают метод EchoToEth смарт-контракта на Ethereum, передавая туда параметры предполагаемой транзакции и увеличивая счетчик голосов.
- По достижению необходимого количества голосов на смарт-контракте Ethereum осуществляется отправка указанного количества eth на адрес получателя.

Обратная транзакция требует дополнительного события, т.к. количество eth на смарт-контракте уменьшается, соответственно должно уменьшиться кол-во eEth в обороте. При подтверждении заверителями перевода, создается событие, которое должно быть отображено на ECHO сети и результатом обработки которого должно стать уничтожение требуемого объема eEth.

Возможен также и другой подход, в котором дополнительного события не генерируется, но eEth остается на балансе смарт-контракта. За неимением методов вывода средств на стороне ECHO, данный актив изымается из общего оборота.

Также обратный сценарий предполагает транзакции на сети ethereum от заверителей, что поднимает вопрос о комиссии (**позже в отдельной секции, еще не прорабатывалось**).

## Изменение набора заверителей
![Eth.png](Eth.png)

Изменение списка заверителей происходит во время обслуживания сети (maintenance). За раз может смениться максимум `1/3*n-1`. Это необходимо для того, чтобы смену могли подтвердить только оставшиеся в текущем наборе заверители, без учета исключенных и добавленных.

После смены заверителей, на стороне echo протоколом вызывается (с помощью виртуальной операции, подтверждать не нужно) метод контракта `replaceWits(array<address> new_wits)`, который заменяет набор аккаунтов, соотвествующий заверителям в контракте. На стороне ethereum текущими заверителями вызывается метод контракта `replaceWits(array<address> new_wits)`, в который передается новый набор заверителей. После вызова в методе получается хэш переданного набора адресов заверителей и записывается в массив голосов по индексу, соответствующему адресу вызвавшего заверителя из текущего набора. После добавления оценивается содержимое массива и при наличии в нем необходимого количества хэшей - переданный набор становится текущим набором заверителей.

# Комиссия Ethereum

Транзакции на Ethereum требуют комиссии для своего выполнения. Транзакция Ethereum -> ECHO оплачивается пользователем, но обращение к смарт-контракту при обратном переводе, а именно, транзакции-подтверждения от заверителей, оплачиваются уже заверителями. Из-за этого возникают следующие проблемы:

- Необходимость наличия eth у заверителя в количестве, достаточном для оплаты транзакции-подтверждения.
- Нетривиальность механизма определения размера комиссии, достаточной для попадания транзакции-подтверждения в блок.
- Учет затрат заверителей при подсчете их награды

[График среднего значения GasPrice](https://etherscan.io/chart/gasprice)

При этом возможен другой подход, при котором заверители выпускают подтверждения переводов в некоторый сторонний канал, используя который пользователи могут составить соответствующие транзакции и выпустить их на сеть в тот момент, когда сочтут комиссию приемлемой

Также существует проблема в виде процедуры изменения состава заверителей. Данная транзакция никак не зависит от наличия средств на смарт-контракте Ethereum, соответственно может возникнуть необходимость в ней при пустом балансе смарт-контракта.